<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MAT276 — Indefinite Integral Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.29.3/full/pyodide.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#4b5563;
      --line:#d1d5db;
      --accent:#2563eb;
      --bad:#b91c1c;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 10% 0%, #e7efff 0%, var(--bg) 55%);
      color:var(--ink);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:24px; }
    h1{ margin:0 0 6px; font-size:22px; }
    .sub{ color:var(--muted); font-size:14px; margin-bottom:18px; line-height:1.35; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow:0 10px 26px rgba(0,0,0,.06);
    }

    .integral-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
    }
    .int-symbol{
      font-size:30px;
      line-height:1;
      padding:0 4px;
      user-select:none;
    }
    input[type="text"]{
      font-family:var(--mono);
      font-size:14px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      outline:none;
      background:#fff;
      color:var(--ink);
      min-width: 220px;
      flex: 1 1 360px;
    }
    .dx{
      display:flex;
      align-items:center;
      gap:8px;
      flex: 0 0 auto;
    }
    .dchar{ font-family:var(--mono); font-size:16px; }
    .varbox{
      width:90px;
      min-width:90px;
      flex: 0 0 90px;
      text-align:center;
      font-weight:700;
    }
    @media (max-width: 600px){
      input[type="text"]{ flex-basis: 100%; min-width: 0; }
      .dx{ width: 100%; justify-content:flex-start; }
      .varbox{ width: 120px; flex: 0 0 120px; }
    }

    .callout{
      margin-top:12px;
      padding:10px 12px;
      border-radius:10px;
      background:#eef2ff;
      border:1px solid #c7d2fe;
      font-size:13px;
      line-height:1.35;
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border:1px solid rgba(17,24,39,.12);
      border-radius:999px;
      font-family:var(--mono);
      font-size:12px;
      background:rgba(0,0,0,.03);
    }

    button{
      margin-top:14px;
      padding:10px 16px;
      font-size:14px;
      font-weight:800;
      border-radius:10px;
      border:1px solid #c7d2fe;
      background:#e0e7ff;
      cursor:pointer;
    }
    button:hover{ background:#dbe5ff; }
    button:disabled{ opacity:.65; cursor:not-allowed; }

    .status{ margin-top:10px; font-size:13px; color:var(--muted); }

    .out{
      margin-top:18px;
      padding:14px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      overflow:auto;
    }
    .math{ font-size:18px; line-height:1.6; white-space:normal; }

    .msg{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(185,28,28,.25);
      background:rgba(185,28,28,.06);
      color:var(--bad);
      font-size:13px;
      line-height:1.35;
      display:none;
      white-space:pre-wrap;
    }

    details.debug{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
    }
    details.debug pre{
      white-space:pre-wrap;
      background:rgba(0,0,0,.03);
      border:1px solid rgba(17,24,39,.10);
      border-radius:10px;
      padding:10px;
      overflow:auto;
      font-family:var(--mono);
      font-size:12px;
      color:#111827;
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>MAT276 — Indefinite Integral Calculator</h1>
  <div class="sub">
    Enter your integrand and the variable after the <span class="pill">d</span>, then click <b>Integrate</b>.
    Natural logarithms are displayed as <b>ln</b>.
  </div>

  <div class="card">
    <div class="integral-row">
      <div class="int-symbol">∫</div>

      <input id="expr" type="text" spellcheck="false" autocomplete="off"
             value="1/(y*(1-y/800))"
             placeholder="Enter f(x), e.g. sin(x)^2 or 1/(x*(x+2))" />

      <div class="dx">
        <div class="dchar">d</div>
        <input id="variable" class="varbox" type="text" spellcheck="false" autocomplete="off"
               value="y" placeholder="x" />
      </div>
    </div>

    <div class="callout">
      <b>IMPORTANT:</b> Use <span class="pill">*</span> when multiplying
      (e.g. <span class="pill">2*x</span>, <span class="pill">(x+1)*(x-3)</span>).
      Also make sure you set the variable after the <span class="pill">d</span>
      (for example, <span class="pill">dx</span> means integrate with respect to <span class="pill">x</span>).
    </div>

    <button id="btnIntegrate" disabled>Loading engine…</button>
    <div class="status" id="status">Initializing SymPy…</div>

    <div class="msg" id="friendlyError"></div>

    <div class="out">
      <div class="math" id="output">—</div>

      <!-- Instructor-only debug: hidden unless an error happens -->
      <details class="debug" id="debugDetails" style="display:none;">
        <summary>Show technical details (instructor)</summary>
        <pre id="debugText"></pre>
      </details>
    </div>
  </div>
</div>

<script>
let pyodide = null;

function renderMath(){
  if (!window.renderMathInElement) return;
  renderMathInElement(document.body, {
    delimiters: [
      {left:"\\(", right:"\\)", display:false},
      {left:"\\[", right:"\\]", display:true}
    ],
    throwOnError:false
  });
}

function setStatus(text){
  document.getElementById("status").textContent = text;
}

function showFriendlyError(msg, debug=null){
  const box = document.getElementById("friendlyError");
  box.style.display = "block";
  box.textContent = msg;

  const dbg = document.getElementById("debugDetails");
  const dbgText = document.getElementById("debugText");
  if (debug){
    dbg.style.display = "block";
    dbgText.textContent = String(debug);
  } else {
    dbg.style.display = "none";
    dbgText.textContent = "";
  }
}

function clearFriendlyError(){
  const box = document.getElementById("friendlyError");
  box.style.display = "none";
  box.textContent = "";
  document.getElementById("debugDetails").style.display = "none";
  document.getElementById("debugText").textContent = "";
}

function sanitizeForPythonTripleQuotes(s){
  return String(s).replace(/'''/g, "\\'\\'\\'");
}

function replaceLogWithLn(tex){
  // SymPy LaTeX uses \log for natural log by default.
  // This makes it display as \ln for students.
  return String(tex).replace(/\\log/g, "\\ln");
}

async function initPyodide(){
  pyodide = await loadPyodide();
  await pyodide.loadPackage("sympy");

  const btn = document.getElementById("btnIntegrate");
  btn.disabled = false;
  btn.textContent = "Integrate";
  setStatus("Ready.");
}

async function integrate(){
  clearFriendlyError();

  const expr = document.getElementById("expr").value.trim();
  const v = (document.getElementById("variable").value.trim() || "x").replace(/\s+/g,"");

  if (!expr){
    showFriendlyError("Please enter an integrand (the function inside the integral).");
    return;
  }
  if (!/^[A-Za-z_]\w*$/.test(v)){
    showFriendlyError("Please enter a valid variable of integration (examples: x, y, t).");
    return;
  }

  setStatus("Computing…");

  const exprSafe = sanitizeForPythonTripleQuotes(expr);

  // IMPORTANT CHANGE:
  // We ask SymPy to LaTeX BOTH the integrand and the antiderivative.
  // That removes the need for any homemade TeX conversion and prevents the \\int/\\cdot issues.
  const code = `
import sympy as sp
var = sp.Symbol('${v}')
expr = sp.sympify(r'''${exprSafe}''')
F = sp.integrate(expr, var)
F = sp.simplify(F)
expr_tex = sp.latex(expr)
F_tex = sp.latex(F)
expr_tex + "|||"+ F_tex
`;

  try{
    const joined = await pyodide.runPythonAsync(code);
    const parts = String(joined).split("|||");
    const exprTex = replaceLogWithLn(parts[0] || "");
    const FTex = replaceLogWithLn(parts[1] || "");

    // Note: use SINGLE backslash TeX commands inside \(...\)
    const latexLine = `\\int ${exprTex}\\, d${v} = ${FTex} + C`;
    document.getElementById("output").innerHTML = `\\(${latexLine}\\)`;

    setStatus("Done.");
    renderMath();
  } catch(e){
    showFriendlyError(
      "I couldn’t parse that expression. Double-check:\n" +
      "• Use * for multiplication (example: 2*x, (x+1)*(x-3))\n" +
      "• Use ^ for powers (example: x^2)\n" +
      "• Make sure the variable after the d is correct (dx, dy, dt)\n" +
      "Then try again.",
      e
    );
    setStatus("Not computed.");
    document.getElementById("output").textContent = "—";
  }
}

document.getElementById("btnIntegrate").addEventListener("click", integrate);

// Enter key convenience
document.getElementById("expr").addEventListener("keydown", (ev) => {
  if (ev.key === "Enter") { ev.preventDefault(); integrate(); }
});
document.getElementById("variable").addEventListener("keydown", (ev) => {
  if (ev.key === "Enter") { ev.preventDefault(); integrate(); }
});

initPyodide();
window.addEventListener("load", renderMath);
</script>
</body>
</html>
